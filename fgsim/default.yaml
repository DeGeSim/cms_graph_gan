tag: default
loglevel: 1
seed: 0
comet_project_name: "normal"

models:
    gen:
        name: gen_deeptree
        params: ${model_param_options[${models.gen.name}]}
        losses: "${optionlist:${loss_options},${models.gen.losses_list}}"
        # losses_list: [WGenLoss]
        losses_list: [CEGenLoss,mean_dist]
        optim:
            name: Adam
            params: ${optim_options[Adam]}
    disc:
        name: disc_prog
        params: ${model_param_options[${models.disc.name}]}
        losses: "${optionlist:${loss_options},${models.disc.losses_list}}"
        # losses_list: [WDiscLoss,GradientPenalty]
        losses_list: [CEDiscLoss]
        optim:
            name: Adam
            params: ${optim_options[Adam]}

ffn:
    activation: ReLU
    activation_params: {}
    init_weights_bias_const: 0.1
    init_weights: xavier_uniform_


model_param_options:
    gen_treepc:
        features: [96, 64, 64, 64, 64, 64, 4]
        degrees: [2, 2, 2, 2, 2, 64]
        support: 10
    gen_deeptree:
        n_global: 5
        conv_name: AncestorConv
        conv_parem: ${layer_options[${model_param_options.gen_deeptree.conv_name}]}
        branching_param: ${layer_options[BranchingLayer]}
        pp_conv: False
    gen_edgeconv:
        n_layers: 5
        n_features: 2
        n_global: 5
    disc_hlvs: {}
    disc_graphgym: {}
    disc_treepc:
        features: [4, 64, 128, 256]
    disc_prog:
      leveldisc: disc_graphgym
      levelparams: {}

tree:
    branches: [2, 4, 4, 16]
    features: [64,64,32,16,2]


layer_options:
    GINConv: {}
    AncestorConv:
        residual: True
    BranchingLayer:
        residual: True


loss_options:
    WGenLoss:
        factor: 1.0
    WDiscLoss:
        factor: 1.0
    CEDiscLoss:
        factor: 1.0
    CEGenLoss:
        factor: 1.0
    GradientPenalty:
        factor: 1.0
        gamma: 1.0
    mean_dist:
        factor: 1.0
    physics:
        factor: 1.0
    frechetpcdist:
        factor: 1.0

optim_options:
    Adam:
        weight_decay: 0.0001
        lr: 0.0002
    SGD:
        lr: 0.0002

training:
    events_processed_before_validation: 100000
    disc_steps_per_gen_step: 2
    early_stopping:
        validation_steps: 100
        improvement: 0.02
    checkpoint_minutes: 30
validation:
    interval: "${div:${training.events_processed_before_validation},${loader.batch_size}}"
    stop_key: stop_key
    metrics:
        hlv_w1:
            factor: 1.0
            wgrad: False
            foreach_hlv: True
testing:
    n_events: 2000

path:
    dataset: "${loader.dataset_path}"
    # dataset: "data/hgcal_william"
    dataset_glob: "**/*.root"
    dataset_processed: "${path.dataset}/pkl_${loader_name}_${loader_hash}"
    ds_lenghts: "${path.dataset_processed}/filelengths.yaml"
    validation: "${path.dataset_processed}/validation.pt"
    test: "${path.dataset_processed}/test.pt"
    training: "${path.dataset_processed}/training"
    training_glob: "*.pt"
    geo_lup: "data/geo_hgcal/DetIdLUT.root"
    run_path: "wd/${tag}/${hash}"
    full_config: "${path.run_path}/full_config.yaml"
    tensorboard: "${path.run_path}/tb"
    checkpoint: "${path.run_path}/checkpoint.torch"
    checkpoint_old: "${path.run_path}/checkpoint_old.torch"
    state: "${path.run_path}/state.yaml"
    state_old: "${path.run_path}/state_old.yaml"
    comet_exp_key: "${path.run_path}/comet_experiment_key"


loader: "${merge:${loader_options[default]},${loader_options[${loader_name}]}}"
loader_name: normal

loader_options:
    default:
        rootprefix: "treeMaker/tree"
        preprocess_training: True
        debug: False
        braches:
            id: "simHit_detid"
            energy: "genPh_E"
            hit_energy: "simHit_E"
        cell_prop_keys: ["E","x", "y", "z"]
        n_features: 4
        chunksize: 100
        batch_size: 50
        validation_set_size: 5000
        test_set_size: 30000
        prefetch_batches: 2
        num_workers_transform: 40
        num_workers_stack: 1
        num_workers_postprocess: 5
        max_points: 4085
        dataset_path: "data/hgcal_william"
    hgcal:
        cell_prop_keys: ["x", "y", "z", "celltype", "issilicon"]
        batch_size: 100
    pcgraph:
        debug: True
    puregraph:
        preprocess_training: False
    normal:
        preprocess_training: False
        cell_prop_keys: ["x", "y"]
        n_features: 2
        # chunksize: 5000
        events_per_file: 10000
        max_points: 512
        dataset_path: "data/normal"
    moons:
        cell_prop_keys: ["x", "y"]
        n_features: 2
        events_per_file: 10000
        max_points: 512
        dataset_path: "data/moons"
